# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ–¤ GITHUB PAGES DEPLOYMENT + CONFIG-DRIVEN PLAYWRIGHT TESTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Flow:
#   1. Build and deploy to GitHub Pages
#   2. Read config.js to determine which tests to run
#   3. Run only enabled test suites (skip passing tests to save CI minutes)
#   4. Visual test status with individual workflow lights per test suite
#
# ğŸ® CONTROL TESTS FROM config.js:
#   - GameConfig.cicd.runAllTests = true  â†’ Run ALL tests (override)
#   - GameConfig.cicd.testSuites.newGame = false â†’ Skip new-game tests
#   - Toggle individual suites to save CI time on passing tests
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Deploy and Test

on:
  push:
    branches:
      - main
      - master

  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¦ BUILD JOB - Prepare the static site
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“„ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ DEPLOY JOB - Push to GitHub Pages
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” READ CONFIG - Extract test settings from config.js
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  read-config:
    runs-on: ubuntu-latest
    needs: deploy
    outputs:
      run_all: ${{ steps.parse.outputs.run_all }}
      new_game: ${{ steps.parse.outputs.new_game }}
      debug_commands: ${{ steps.parse.outputs.debug_commands }}
      debug: ${{ steps.parse.outputs.debug }}
      panels: ${{ steps.parse.outputs.panels }}
      features: ${{ steps.parse.outputs.features }}
      settings: ${{ steps.parse.outputs.settings }}
      ui_elements: ${{ steps.parse.outputs.ui_elements }}
      comprehensive_ui: ${{ steps.parse.outputs.comprehensive_ui }}
      page_url: ${{ needs.deploy.outputs.page_url }}
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Parse config.js for CI/CD settings
        id: parse
        run: |
          # ğŸ–¤ Extract the cicd config from config.js using Node
          node -e "
            const fs = require('fs');
            const content = fs.readFileSync('config.js', 'utf8');

            // Extract runAllTests
            const runAllMatch = content.match(/runAllTests:\s*(true|false)/);
            const runAll = runAllMatch ? runAllMatch[1] : 'false';

            // Extract individual test suite settings
            const suites = {
              newGame: content.match(/newGame:\s*(true|false)/),
              debugCommands: content.match(/debugCommands:\s*(true|false)/),
              debug: content.match(/debug:\s*(true|false)/),
              panels: content.match(/panels:\s*(true|false)/),
              features: content.match(/features:\s*(true|false)/),
              settings: content.match(/settings:\s*(true|false)/),
              uiElements: content.match(/uiElements:\s*(true|false)/),
              comprehensiveUi: content.match(/comprehensiveUi:\s*(true|false)/)
            };

            // Output for GitHub Actions
            console.log('run_all=' + runAll);
            console.log('new_game=' + (suites.newGame ? suites.newGame[1] : 'true'));
            console.log('debug_commands=' + (suites.debugCommands ? suites.debugCommands[1] : 'true'));
            console.log('debug=' + (suites.debug ? suites.debug[1] : 'true'));
            console.log('panels=' + (suites.panels ? suites.panels[1] : 'true'));
            console.log('features=' + (suites.features ? suites.features[1] : 'true'));
            console.log('settings=' + (suites.settings ? suites.settings[1] : 'true'));
            console.log('ui_elements=' + (suites.uiElements ? suites.uiElements[1] : 'true'));
            console.log('comprehensive_ui=' + (suites.comprehensiveUi ? suites.comprehensiveUi[1] : 'true'));
          " >> $GITHUB_OUTPUT

      - name: ğŸ“Š Display Test Configuration
        run: |
          echo "## ğŸ® Test Configuration from config.js" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Enabled |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¥ Run All (Override) | ${{ steps.parse.outputs.run_all }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ® New Game | ${{ steps.parse.outputs.new_game }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ› Debug Commands | ${{ steps.parse.outputs.debug_commands }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Debug | ${{ steps.parse.outputs.debug }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“‹ Panels | ${{ steps.parse.outputs.panels }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¯ Features | ${{ steps.parse.outputs.features }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Settings | ${{ steps.parse.outputs.settings }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ–¥ï¸ UI Elements | ${{ steps.parse.outputs.ui_elements }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¨ Comprehensive UI | ${{ steps.parse.outputs.comprehensive_ui }} |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª TEST SETUP - Install dependencies and prepare
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-setup:
    runs-on: ubuntu-latest
    needs: [deploy, read-config]
    outputs:
      page_url: ${{ needs.deploy.outputs.page_url }}
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ğŸ“¤ Cache Playwright
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ® TEST: New Game Flow
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-new-game:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-setup]
    if: needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.new_game == 'true'
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Restore cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”§ Install if cache miss
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          if [ ! -d "$HOME/.cache/ms-playwright" ]; then npx playwright install --with-deps chromium; fi

      - name: ğŸ§ª Run New Game Tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.page_url }}
        run: npx playwright test tests/new-game.spec.js --reporter=line

      - name: ğŸŸ¢ Tests Passed
        if: success()
        run: echo "## ğŸ® New Game Tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”´ Tests Failed
        if: failure()
        run: echo "## ğŸ® New Game Tests: âŒ FAILED" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ› TEST: Debug Commands
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-debug-commands:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-setup]
    if: needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.debug_commands == 'true'
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Restore cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”§ Install if cache miss
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          if [ ! -d "$HOME/.cache/ms-playwright" ]; then npx playwright install --with-deps chromium; fi

      - name: ğŸ§ª Run Debug Command Tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.page_url }}
        run: npx playwright test tests/debug-commands.spec.js --reporter=line

      - name: ğŸŸ¢ Tests Passed
        if: success()
        run: echo "## ğŸ› Debug Commands: âœ… PASSED" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”´ Tests Failed
        if: failure()
        run: echo "## ğŸ› Debug Commands: âŒ FAILED" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” TEST: Debug (Console Errors)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-debug:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-setup]
    if: needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.debug == 'true'
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Restore cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”§ Install if cache miss
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          if [ ! -d "$HOME/.cache/ms-playwright" ]; then npx playwright install --with-deps chromium; fi

      - name: ğŸ§ª Run Debug Tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.page_url }}
        run: npx playwright test tests/debug.spec.js --reporter=line

      - name: ğŸŸ¢ Tests Passed
        if: success()
        run: echo "## ğŸ” Debug: âœ… PASSED" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”´ Tests Failed
        if: failure()
        run: echo "## ğŸ” Debug: âŒ FAILED" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ TEST: Panel Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-panels:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-setup]
    if: needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.panels == 'true'
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Restore cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”§ Install if cache miss
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          if [ ! -d "$HOME/.cache/ms-playwright" ]; then npx playwright install --with-deps chromium; fi

      - name: ğŸ§ª Run Panel Tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.page_url }}
        run: npx playwright test tests/panels.spec.js --reporter=line

      - name: ğŸŸ¢ Tests Passed
        if: success()
        run: echo "## ğŸ“‹ Panel Tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”´ Tests Failed
        if: failure()
        run: echo "## ğŸ“‹ Panel Tests: âŒ FAILED" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ¯ TEST: Features
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-features:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-setup]
    if: needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.features == 'true'
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Restore cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”§ Install if cache miss
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          if [ ! -d "$HOME/.cache/ms-playwright" ]; then npx playwright install --with-deps chromium; fi

      - name: ğŸ§ª Run Feature Tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.page_url }}
        run: npx playwright test tests/features.spec.js --reporter=line

      - name: ğŸŸ¢ Tests Passed
        if: success()
        run: echo "## ğŸ¯ Feature Tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”´ Tests Failed
        if: failure()
        run: echo "## ğŸ¯ Feature Tests: âŒ FAILED" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # âš™ï¸ TEST: Settings
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-settings:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-setup]
    if: needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.settings == 'true'
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Restore cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”§ Install if cache miss
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          if [ ! -d "$HOME/.cache/ms-playwright" ]; then npx playwright install --with-deps chromium; fi

      - name: ğŸ§ª Run Settings Tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.page_url }}
        run: npx playwright test tests/settings.spec.js --reporter=line

      - name: ğŸŸ¢ Tests Passed
        if: success()
        run: echo "## âš™ï¸ Settings Tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”´ Tests Failed
        if: failure()
        run: echo "## âš™ï¸ Settings Tests: âŒ FAILED" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ–¥ï¸ TEST: UI Elements
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-ui-elements:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-setup]
    if: needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.ui_elements == 'true'
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Restore cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”§ Install if cache miss
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          if [ ! -d "$HOME/.cache/ms-playwright" ]; then npx playwright install --with-deps chromium; fi

      - name: ğŸ§ª Run UI Element Tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.page_url }}
        run: npx playwright test tests/ui-elements.spec.js --reporter=line

      - name: ğŸŸ¢ Tests Passed
        if: success()
        run: echo "## ğŸ–¥ï¸ UI Element Tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”´ Tests Failed
        if: failure()
        run: echo "## ğŸ–¥ï¸ UI Element Tests: âŒ FAILED" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ¨ TEST: Comprehensive UI
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-comprehensive-ui:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-setup]
    if: needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.comprehensive_ui == 'true'
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Restore cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”§ Install if cache miss
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          if [ ! -d "$HOME/.cache/ms-playwright" ]; then npx playwright install --with-deps chromium; fi

      - name: ğŸ§ª Run Comprehensive UI Tests
        env:
          BASE_URL: ${{ needs.deploy.outputs.page_url }}
        run: npx playwright test tests/comprehensive-ui.spec.js --reporter=line

      - name: ğŸŸ¢ Tests Passed
        if: success()
        run: echo "## ğŸ¨ Comprehensive UI Tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”´ Tests Failed
        if: failure()
        run: echo "## ğŸ¨ Comprehensive UI Tests: âŒ FAILED" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š FINAL SUMMARY - Aggregate all test results
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-summary:
    runs-on: ubuntu-latest
    needs: [deploy, read-config, test-new-game, test-debug-commands, test-debug, test-panels, test-features, test-settings, test-ui-elements, test-comprehensive-ui]
    if: always()
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate Visual Test Summary
        env:
          DEPLOY_URL: ${{ needs.deploy.outputs.page_url }}
          RUN_ALL: ${{ needs.read-config.outputs.run_all }}
          NEW_GAME_ENABLED: ${{ needs.read-config.outputs.new_game }}
          DEBUG_COMMANDS_ENABLED: ${{ needs.read-config.outputs.debug_commands }}
          DEBUG_ENABLED: ${{ needs.read-config.outputs.debug }}
          PANELS_ENABLED: ${{ needs.read-config.outputs.panels }}
          FEATURES_ENABLED: ${{ needs.read-config.outputs.features }}
          SETTINGS_ENABLED: ${{ needs.read-config.outputs.settings }}
          UI_ELEMENTS_ENABLED: ${{ needs.read-config.outputs.ui_elements }}
          COMPREHENSIVE_ENABLED: ${{ needs.read-config.outputs.comprehensive_ui }}
          NEW_GAME: ${{ needs.test-new-game.result }}
          DEBUG_CMDS: ${{ needs.test-debug-commands.result }}
          DEBUG: ${{ needs.test-debug.result }}
          PANELS: ${{ needs.test-panels.result }}
          FEATURES: ${{ needs.test-features.result }}
          SETTINGS: ${{ needs.test-settings.result }}
          UI_ELEMENTS: ${{ needs.test-ui-elements.result }}
          COMPREHENSIVE: ${{ needs.test-comprehensive-ui.result }}
        run: |
          # Status indicator function
          status_icon() {
            case "$1" in
              "success") echo "âœ…" ;;
              "failure") echo "âŒ" ;;
              "skipped") echo "â­ï¸" ;;
              *) echo "âšª" ;;
            esac
          }

          # Generate summary
          echo "# ğŸ–¤ Medieval Trading Game - Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed to:** $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ® Config-Driven Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests controlled by \`GameConfig.cicd\` in \`config.js\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$RUN_ALL" = "true" ]; then
            echo "ğŸ”¥ **Run All Override: ENABLED** - All tests executed regardless of individual settings" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Config | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ® New Game | $NEW_GAME_ENABLED | $(status_icon $NEW_GAME) $NEW_GAME |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ› Debug Commands | $DEBUG_COMMANDS_ENABLED | $(status_icon $DEBUG_CMDS) $DEBUG_CMDS |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Debug | $DEBUG_ENABLED | $(status_icon $DEBUG) $DEBUG |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“‹ Panels | $PANELS_ENABLED | $(status_icon $PANELS) $PANELS |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¯ Features | $FEATURES_ENABLED | $(status_icon $FEATURES) $FEATURES |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Settings | $SETTINGS_ENABLED | $(status_icon $SETTINGS) $SETTINGS |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ–¥ï¸ UI Elements | $UI_ELEMENTS_ENABLED | $(status_icon $UI_ELEMENTS) $UI_ELEMENTS |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¨ Comprehensive UI | $COMPREHENSIVE_ENABLED | $(status_icon $COMPREHENSIVE) $COMPREHENSIVE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ **Tip:** Set \`GameConfig.cicd.testSuites.suiteName = false\` to skip passing tests" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Fail if any enabled tests failed
        if: |
          (needs.test-new-game.result == 'failure') ||
          (needs.test-debug-commands.result == 'failure') ||
          (needs.test-debug.result == 'failure') ||
          (needs.test-panels.result == 'failure') ||
          (needs.test-features.result == 'failure') ||
          (needs.test-settings.result == 'failure') ||
          (needs.test-ui-elements.result == 'failure') ||
          (needs.test-comprehensive-ui.result == 'failure')
        run: exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¤ ARTIFACTS - Upload test reports (only when tests run)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  upload-artifacts:
    runs-on: ubuntu-latest
    needs: [read-config, test-new-game, test-debug-commands, test-debug, test-panels, test-features, test-settings, test-ui-elements, test-comprehensive-ui]
    if: always() && (needs.read-config.outputs.run_all == 'true' || needs.read-config.outputs.new_game == 'true' || needs.read-config.outputs.debug_commands == 'true' || needs.read-config.outputs.panels == 'true' || needs.read-config.outputs.features == 'true' || needs.read-config.outputs.settings == 'true' || needs.read-config.outputs.ui_elements == 'true' || needs.read-config.outputs.comprehensive_ui == 'true')
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ğŸ§ª Run all tests for report
        continue-on-error: true
        run: npx playwright test --reporter=html

      - name: ğŸ“¤ Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: ğŸ“¤ Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots
          path: test-results/
          retention-days: 7
